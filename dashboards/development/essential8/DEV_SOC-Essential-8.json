{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Introduction\r\n\r\nThis workbook supports ongoing security governance and aligns with **Essential Eight recommendations** by providing visibility into common risk areas across the Microsoft 365 environment.  \r\n\r\nThe goal is to create a single view where administrators can monitor and track activities that directly map to Essential Eight controls. This helps reduce attack surface, highlight risks, and improve operational hygiene across the tenant.\r\n"
            },
            "name": "text - 0"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Stale or Inactive User Accounts\r\n\r\nThis section highlights **active and enabled accounts** that have not been used recently. Dormant accounts represent a security risk, as they may be exploited by attackers if left unmanaged.  \r\n\r\nThe workbook calculates the **days since the last successful sign-in** and places accounts into **Inactivity Buckets** to make risks clear:\r\n\r\n- **Active (<30 days)** – Recently used; no action required.  \r\n- **Review (30–90 days)** – Infrequent use; review with user or owner.  \r\n- **Low Activity (90–180 days)** – Extended inactivity; validate necessity with user.  \r\n- **Stale (>180 days)** – Dormant accounts; candidates for removal or disablement.  \r\n\r\n### Color Coding\r\n- **Dark Red** – Stale (No sign-in >180 days, candidate for removal)  \r\n- **Orange** – Low Activity (90–180 days, check with user)  \r\n- **Yellow** – Review (30–90 days, infrequent use)  \r\n\r\nThis helps administrators quickly identify accounts that may no longer be required, aligning with **Essential Eight account lifecycle management** recommendations.\r\n"
                  },
                  "name": "text - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let _SignInPeriod = 720d;\r\nlet _InactivityDayThreshold = 30;\r\nlet _activePeriod = 30d;\r\nlet _userType = \"Member\";\r\nlet _accountPrefixToIgnore = \"zz_\";\r\nlet ActiveAccountIdentityInfo = IdentityInfo\r\n| where TimeGenerated > ago(_activePeriod)\r\n| where isnotempty(IsAccountEnabled) and IsAccountEnabled == true\r\n| where UserType == _userType\r\n| where AccountDisplayName !startswith _accountPrefixToIgnore\r\n| summarize TimeGenerated = max(TimeGenerated) by UserPrincipalName=AccountUPN, UserDisplayName=AccountDisplayName, UserId=AccountObjectId, JobTitle, MailAddress;\r\n//\r\nlet UsersToReportOn = ActiveAccountIdentityInfo | distinct UserId;\r\n//\r\nlet RecentSignInUsers = \r\nAADNonInteractiveUserSignInLogs\r\n| union SigninLogs\r\n| where TimeGenerated > ago(_SignInPeriod)\r\n| where isnotempty(UserId) and UserId in~ (UsersToReportOn)\r\n| where UserType == \"Member\"\r\n| where ResultType == 0\r\n| summarize RecentSignIn = max(TimeGenerated) by UserId;\r\nActiveAccountIdentityInfo\r\n| join kind=leftouter RecentSignInUsers on UserId\r\n| extend UserId = coalesce(UserId, UserId1)\r\n| extend DaysSinceRecentSignIn =\r\n    iif(isnull(RecentSignIn),\r\n        long(null),\r\n        tolong(datetime_diff('day', now(), RecentSignIn)))\r\n| extend InactivityBucket = case(\r\n    isnull(RecentSignIn), \"No Sign-In\",\r\n    datetime_diff('day', now(), RecentSignIn) <= 30, \"Active - Recently used\",\r\n    datetime_diff('day', now(), RecentSignIn) <= 90, \"Review - Infrequent use\",\r\n    datetime_diff('day', now(), RecentSignIn) <= 180, \"Low Activity - Check with user\",\r\n    \"Stale - No sign-in and Dormant - Candidate for removal\")\r\n| project UserDisplayName, UserPrincipalName, DaysSinceRecentSignIn, InactivityBucket, RecentSignIn, UserId, JobTitle\r\n| where DaysSinceRecentSignIn > _InactivityDayThreshold or isempty(DaysSinceRecentSignIn)\r\n| order by DaysSinceRecentSignIn desc, UserDisplayName asc",
                    "size": 3,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "UserId",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "DaysSinceRecentSignIn",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "colors",
                            "thresholdsGrid": [
                              {
                                "operator": ">=",
                                "thresholdValue": "180",
                                "representation": "redDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": ">=",
                                "thresholdValue": "90",
                                "representation": "orangeDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": ">=",
                                "thresholdValue": "30",
                                "representation": "yellowDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "is Empty",
                                "representation": "redBright",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "greenDark",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "InactivityBucket",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "colors",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Stale - No sign-in and Dormant - Candidate for removal",
                                "representation": "redDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Low Activity - Check with user",
                                "representation": "orangeDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Review - Infrequent use",
                                "representation": "yellowDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Active - Recently used",
                                "representation": "greenDark",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "No Sign-In",
                                "representation": "redBright",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "lightBlue",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "UserDisplayName",
                          "label": "Account Name"
                        },
                        {
                          "columnId": "UserPrincipalName",
                          "label": "Account Username"
                        },
                        {
                          "columnId": "DaysSinceRecentSignIn",
                          "label": "Days Since Most Recent Sign-In"
                        },
                        {
                          "columnId": "InactivityBucket",
                          "label": "Inactivity Bucket"
                        },
                        {
                          "columnId": "RecentSignIn",
                          "label": "Most Recent Sign-In"
                        },
                        {
                          "columnId": "UserId",
                          "label": "User ID"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "query - 1"
                }
              ]
            },
            "name": "group - 0",
            "styleSettings": {
              "margin": "2",
              "padding": "2",
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 0",
      "styleSettings": {
        "margin": "2",
        "padding": "2",
        "showBorder": true
      }
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/647ae86e-0a57-4208-ad10-cd71881dd3a8/resourcegroups/rf-australiaeast-prod-security-sentinel-internal-rg/providers/microsoft.operationalinsights/workspaces/rf-sentinel-prod-workspace"
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}